import { google } from "googleapis";
import fs from "fs";

// üìÑ ID —Ç–≤–æ–µ–π —Ç–∞–±–ª–∏—Ü—ã
const SPREADSHEET_ID = "1gS46okY36V86bDdvUEaaH_mu3ZHcvFgJKr-dooPMh1s";
const SHEET_NAME = "Tenders";

// üîë –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
const auth = new google.auth.GoogleAuth({
  keyFile: "./service-account.json",
  scopes: ["https://www.googleapis.com/auth/spreadsheets"],
});
const sheets = google.sheets({ version: "v4", auth });

/**
 * –î–æ–±–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ–Ω–¥–µ—Ä–∞ –≤ Google Sheets
 * @param {Object} tenderData ‚Äî –æ—Ç–≤–µ—Ç –æ—Ç –°–ë–ò–°
 */
export async function appendTenderResultToExcel(tenderData) {
  const tender = tenderData?.result?.tenders?.[0];
  if (!tender) throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç –°–ë–ò–°");
// –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—É–±–ª–∏ –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–Ω–¥–µ—Ä–∞
const existing = await sheets.spreadsheets.values.get({
  spreadsheetId: SPREADSHEET_ID,
  range: `${SHEET_NAME}!A:A`, // –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –≤ –∫–æ–ª–æ–Ω–∫–µ A —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–æ–º–µ—Ä–∞
});

const existingNumbers = (existing.data.values || []).flat();
if (existingNumbers.includes(tender.number)) {
  console.log(`‚ö†Ô∏è –¢–µ–Ω–¥–µ—Ä ${tender.number} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî –ø—Ä–æ–ø—É—Å–∫.`);
  return;
}

  const values = [];

  // üßæ –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ —Ç–µ–Ω–¥–µ—Ä–∞
  const tenderRow = [
    tender.number,
    tender.name,
    tender.status,
    tender.type,
    tender.region,
    tender.initiator_name,
    tender.organizer_name,
    tender.price,
    tender.publish_date,
    tender.request_receiving_date,
    tender.tender_date,
    tender.lots?.[0]?.delivery_term || "",
    tender.win_price,
    tender.winner_name,
    tender.winner_inn,
    tender.smp || "",
    tender.lots?.[0]?.contract_number || "",
tender.tender_url
    ? `=HYPERLINK("${tender.tender_url}"; "–û—Ç–∫—Ä—ã—Ç—å –≤ –ï–ò–°")`
    : "",
    "", "", "", "", "", ""
  ];
  values.push(tenderRow);

  // üß© –í–ª–æ–∂–µ–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ (–ª–æ—Ç—ã –∏ —Ç–æ–≤–∞—Ä—ã)
  for (const lot of tender.lots || []) {
    for (const item of lot.items || []) {
      const lotRow = [
       "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "",
        `‚Üí ${item.name}`,                        // –æ—Ç—Å—Ç—É–ø –∏ –∏–º—è —Ç–æ–≤–∞—Ä–∞
        item.price / item.quantity || "",        // —Ü–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É
        item.quantity || "",
        lot.price || "",
        item.ktru_code || "",
        item.okpd2?.[0]?.code || "",
      ];
      values.push(lotRow);
    }
  }

  // ‚úçÔ∏è –ó–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü—É
  await sheets.spreadsheets.values.append({
    spreadsheetId: SPREADSHEET_ID,
    range: `${SHEET_NAME}!A:Z`,
    valueInputOption: "USER_ENTERED",
    requestBody: {
      values,
    },
  });

  console.log(`‚úÖ –¢–µ–Ω–¥–µ—Ä ${tender.number} –¥–æ–±–∞–≤–ª–µ–Ω –≤ Google Sheets.`);
}
